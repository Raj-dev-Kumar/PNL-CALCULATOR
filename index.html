<!-- Project: Value Calculator Website with Node.js + Express Backend -->
<!-- Below is a full project code including frontend (index.html) and backend (server.js) -->

<!-- ========================= index.html ========================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css">
  <title>PNL Calculator</title>
</head>
<body>
  <h1>PNL Calculator</h1>
<div id="calculatorContainer">
  <label>Port Total: <input type="number" id="portTotal" /></label>
  <br /><br />

  <table id="dataTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>MC Entrada</th>
        <th>MC Saida</th>
        <th>Valor Entrada</th>
        <th>CA</th>
        <th>DELETE</th>
        <th>PERCENTAGE</th>
        <th>SOL PNL</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="pagination" style="margin-top:10px;">
  <button onclick="prevPage()">Prev</button>
  <span id="pageInfo">Page 1</span>
  <button onclick="nextPage()">Next</button>
</div>

  <button onclick="addRow()">Add Row</button>
  <button onclick="saveData()">Save</button>
  <button onclick="calculate()">Calculate</button>
  <button onclick="backupData()">Backup Data</button>

  <h2>Total Value: <span id="totalValue">0</span></h2>
  <h2>Port % <span id="portdf">0</span></h2>

  </div>

<script>
  let storedRows = [];   // This replaces reading rows directly from the DOM
let currentPage = 1;
const pageSize = 8;    // Number of entries per pag
  // Load data from server
  window.onload = async function() {
    const res = await fetch('http://localhost:3000/load');
    const data = await res.json();

     if (data.rows) storedRows = data.rows;
 /*   if (data.rows) {
      data.rows.forEach(r => addRow(r));
      console.log(data);
    }
      */
    if (data.portTotal) document.getElementById('portTotal').value = data.portTotal;

    renderTable();


    try{
      calculate();
    }
    catch{
      console.log("ERROR Calculating");
    }
  }

function renderTable() {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';

  const start = (currentPage - 1) * pageSize;
  const pageRows = storedRows.slice(start, start + pageSize);

  pageRows.forEach(r => createRowHTML(r));

  const totalPages = Math.ceil(storedRows.length / pageSize) || 1;
  document.getElementById('pageInfo').textContent = `Page ${currentPage} / ${totalPages}`;
}

function createRowHTML(data = {}) {
  const tbody = document.querySelector('#dataTable tbody');
  const row = document.createElement("tr");

  row.innerHTML = `
    <td><input type="text" value="${data.Name || ''}"></td>
    <td><input type="number" value="${data.MCentrada || 0}"></td>
    <td><input type="number" value="${data.MCsaida || 0}"></td>
    <td><input type="number" value="${data.Valorentrada || 0}"></td>
    <td><input type="text" value="${data.CA || ''}"></td>
    <td><button onclick="deleteRow(this)">Delete</button></td>
     <td class="percentCol">${data.percentagem ? data.percentagem.toFixed(2) : 0}%</td>
      <td class="">${ data.percentagem ? data.percentagem.toFixed(2)/100 *data.Valorentrada  : 0} SOL</td>
  `;

  tbody.appendChild(row);
}

function nextPage() {
  const totalPages = Math.ceil(storedRows.length / pageSize);
  if (currentPage < totalPages) {
    currentPage++;
    renderTable();
  }
}

function prevPage() {
  if (currentPage > 1) {
    currentPage--;
    renderTable();
  }
}


async function backupData() {
  try {
    const res = await fetch('http://localhost:3000/backup');
    if(res.ok){
      alert('Backup created successfully!');
    } else {
      alert('Backup failed.');
    }
  } catch(err) {
    console.error(err);
    alert('Error creating backup.');
  }
}

  function addRow(data = {}) {
      const rows = [...document.querySelectorAll('#dataTable tbody tr')];
  rows.forEach((r, i) => {
    const cells = r.querySelectorAll('input');
    const pageStart = (currentPage - 1) * pageSize;
    const realIndex = pageStart + i;

    storedRows[realIndex].Name = cells[0].value;
    storedRows[realIndex].MCentrada = parseFloat(cells[1].value) || 0;
    storedRows[realIndex].MCsaida = parseFloat(cells[2].value) || 0;
    storedRows[realIndex].Valorentrada = parseFloat(cells[3].value) || 0;
    storedRows[realIndex].CA = cells[4].value;
    storedRows[realIndex].percentagem = storedRows[realIndex].MCentrada > 0 ?
      ((storedRows[realIndex].MCsaida - storedRows[realIndex].MCentrada) / storedRows[realIndex].MCentrada * 100) : 0;
    storedRows[realIndex].solpnl = storedRows[realIndex].percentagem%100 * storedRows[realIndex].Valorentrada ;
    });
storedRows.push(data);
  renderTable();
  }

  async function saveData() {
    const rows = [...document.querySelectorAll('#dataTable tbody tr')].map(r => {
      const cells = r.querySelectorAll('input');
      return {
        Name: String(cells[0].value || ''),
        MCentrada: parseFloat(cells[1].value) || 0.0,
        MCsaida: parseFloat(cells[2].value) || 0.0,
        Valorentrada: parseFloat(cells[3].value) || 0.0,
        CA: String(cells[4].value || ''),
        percentagem: parseFloat((parseFloat(cells[2].value)-parseFloat(cells[1].value))/parseFloat(cells[1].value)*100) || 0.0,
        valorSaida:parseFloat(     parseFloat(cells[3].value)*(((parseFloat(cells[2].value)-parseFloat(cells[1].value))/parseFloat(cells[1].value)))                        ) || 0.0,
        solpnl: parseFloat(parseFloat((parseFloat(cells[2].value)-parseFloat(cells[1].value))/parseFloat(cells[1].value))*parseFloat(cells[3].value)) || 0.0
      
      };
    });
    const port = document.getElementById('portTotal').value;
//    const percentagem = (MCsaida-MCentrada)/MCentrada*100;
   // const afetaValor = Valorentrada*(1+(MCsaida-MCentrada)/MCentrada*100);

    await fetch('http://localhost:3000/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rows, portTotal: port })
    });

    console.log('Saved on server!');
        try{
          
      calculate();
      
    }
    catch (e){
      console.log("ERROR Calculating");
      console.log(e);
    }
  }

  function calculate() {
  const rows = [...document.querySelectorAll('#dataTable tbody tr')];
  rows.forEach((r, i) => {
    const cells = r.querySelectorAll('input');
    const pageStart = (currentPage - 1) * pageSize;
    const realIndex = pageStart + i;

    storedRows[realIndex].Name = cells[0].value;
    storedRows[realIndex].MCentrada = parseFloat(cells[1].value) || 0;
    storedRows[realIndex].MCsaida = parseFloat(cells[2].value) || 0;
    storedRows[realIndex].Valorentrada = parseFloat(cells[3].value) || 0;
    storedRows[realIndex].CA = cells[4].value;
    storedRows[realIndex].percentagem = storedRows[realIndex].MCentrada > 0 ? 
        ((storedRows[realIndex].MCsaida - storedRows[realIndex].MCentrada) / storedRows[realIndex].MCentrada * 100) : 0;
    storedRows[realIndex].solpnl = storedRows[realIndex].MCentrada > 0 ? 
        ((storedRows[realIndex].MCsaida - storedRows[realIndex].MCentrada) / storedRows[realIndex].MCentrada ) *storedRows[realIndex].Valorentrada : 0;   
  });
    let total = 0;

    storedRows.forEach(r => {
      const MCentrada = parseFloat(r.MCentrada) || 0;
      const MCsaida = parseFloat(r.MCsaida) || 0;
      const Valorentrada = parseFloat(r.Valorentrada) || 0;
      const percent = MCentrada > 0 ? ((MCsaida - MCentrada)/MCentrada*100) : 0;
    const solpnl = MCentrada > 0 ? ((MCsaida - MCentrada)/MCentrada)*Valorentrada : 0;

      if (MCentrada > 0) {
        const val = Valorentrada * ( (MCsaida - MCentrada) / MCentrada);
        total += val;
      }
    
    
    });

    const port = parseFloat(document.getElementById('portTotal').value) || 0;
    total += port;

    let pdf = (total-port)/port*100;

    document.getElementById('totalValue').innerText = total.toFixed(2);
    document.getElementById('portdf').innerText = pdf.toFixed(2);

    renderTable();
    
  }
function deleteRow(btn) {
  const row = btn.closest("tr");

  const rowIndex = [...row.parentNode.children].indexOf(row); // index inside page
  const pageStart = (currentPage - 1) * pageSize;
  const realIndex = pageStart + rowIndex;

  if (realIndex > -1) {
    storedRows.splice(realIndex, 1);
  }

  renderTable();
  saveData();
}
</script>
</body>
</html>



